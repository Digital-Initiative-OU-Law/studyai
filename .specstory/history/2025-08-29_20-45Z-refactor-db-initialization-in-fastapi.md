<!-- Generated by SpecStory -->

# Refactor DB initialization in FastAPI (2025-08-29 20:45Z)

_**User**_

In backend/app/main.py around lines 26-33 (and similarly 35-38), DB initialization is being executed at import time; move the call to init_db() into a FastAPI startup hook instead to avoid side effects during import and to support testing. Remove the direct init_db() invocation from the module top-level and add either an @app.on_event("startup") async def startup(): (await init_db() if async) or app.add_event_handler("startup", lambda: init_db()) (wrap with asyncio.to_thread or await depending on sync/async signature). Ensure init_db is imported where needed, handle errors/logging inside the startup handler, and delete the duplicate top-level calls at lines 35-38.

---

_**Assistant**_

I'll help you move the database initialization from import time to a FastAPI startup hook. Let me first examine the current code to understand the structure.


---

Read file: backend/app/main.py

---

Now let me check the database module to see if `init_db` is async or sync:


---

Read file: backend/app/database.py

---

Perfect! I can see that `init_db()` is a synchronous function. Now I'll modify the main.py file to move the database initialization to a FastAPI startup hook and remove the top-level calls.


---

<details><summary>Edit file: backend/app/main.py</summary>

I will move the init_db() call from the top-level to a FastAPI startup event handler and remove the duplicate top-level call.

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -3,4 +3,5 @@
  from fastapi import FastAPI
  from fastapi.middleware.cors import CORSMiddleware
+ import asyncio
  
  from .config import settings
```

**Chunk 2**
Lines added: 11, lines removed: 3

```diff
@@ -34,9 +35,17 @@
      app.include_router(tutor_router.router)
  
+     @app.on_event("startup")
+     async def startup():
+         """Initialize database on startup"""
+         try:
+             # Run init_db in a thread since it's synchronous
+             await asyncio.to_thread(init_db)
+         except Exception as e:
+             # Log error but don't crash the app
+             print(f"Failed to initialize database: {e}")
+             # In production, you might want to use proper logging here
+ 
      return app
  
- 
- # Initialize DB structures (no-ops until models are defined)
- init_db()
  
  app = create_app()
```

</details>

---

Perfect! I've successfully moved the database initialization from import time to a FastAPI startup hook. Here's what I changed:

1. **Added `import asyncio`** to support `asyncio.to_thread()`
2. **Moved `init_db()` call** from the top-level (line 35) into a `@app.on_event("startup")` handler
3. **Wrapped the sync function** with `asyncio.to_thread(init_db)` since `init_db()` is synchronous
4. **Added error handling** with a try-catch block to prevent startup failures from crashing the app
5. **Removed the duplicate top-level call** that was at line 35

The changes ensure that:
- Database initialization happens only when the FastAPI app starts up, not during import
- The synchronous `init_db()` function runs in a separate thread to avoid blocking the event loop
- Errors during database initialization are caught and logged without crashing the application
- The code is now testable since there are no side effects during import

This follows FastAPI best practices and eliminates the import-time side effects that could cause issues during testing or when importing the module in other contexts.

---

